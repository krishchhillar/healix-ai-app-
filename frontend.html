<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healix - Gemini Powered AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        #chat-window::-webkit-scrollbar { width: 6px; }
        #chat-window::-webkit-scrollbar-track { background: #f1f1f1; }
        #chat-window::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        #chat-window::-webkit-scrollbar-thumb:hover { background: #555; }
        .pulsing-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background-color: #6b7280;
            animation: pulse 1.4s infinite ease-in-out both;
        }
        .pulsing-dot:nth-child(1) { animation-delay: -0.32s; }
        .pulsing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes pulse {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        .modal { display: none; }
        .modal.active { display: flex; }
        .follow-up-btn { transition: all 0.2s ease-in-out; }
        .follow-up-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen">

    <div class="bg-white w-full max-w-2xl h-[90vh] shadow-lg rounded-xl flex flex-col p-4 md:p-6 m-4">

        <!-- Header -->
        <header class="border-b pb-4 mb-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                 <svg class="w-8 h-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15v-4H8v-2h3V7h2v4h3v2h-3v4h-2z"></path></svg>
                <h1 class="text-2xl font-bold text-gray-800">Healix AI</h1>
            </div>
            <div class="flex items-center space-x-2">
                <button id="summarize-btn" title="Summarize Conversation" class="text-sm font-semibold text-white bg-blue-500 hover:bg-blue-600 rounded-lg px-3 py-2 flex items-center space-x-2">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25H12" /></svg>
                    <span>✨ Summarize</span>
                </button>
            </div>
        </header>

        <!-- Controls -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-center space-y-4 md:space-y-0 md:space-x-4 mb-4">
            <div class="bg-slate-200 p-1 rounded-lg flex">
                <button id="patient-btn" class="px-4 py-1.5 text-sm font-semibold w-full md:w-auto rounded-md bg-white text-blue-600 shadow">For Patients</button>
                <button id="doctor-btn" class="px-4 py-1.5 text-sm font-semibold w-full md:w-auto rounded-md text-gray-600">For Doctors</button>
            </div>
        </div>

        <!-- Chat Window -->
        <div id="chat-window" class="flex-grow overflow-y-auto mb-4 p-4 bg-slate-50 rounded-lg">
             <div class="flex justify-start mb-4">
                <div class="bg-slate-200 text-gray-800 rounded-lg p-3 max-w-xs md:max-w-md">Hello! I'm Healix. Ask me a question based on my knowledge base, or try my ✨ Gemini-powered features!</div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="flex items-center">
            <input type="text" id="message-input" class="flex-grow border rounded-l-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ask a question about a medical condition...">
            <button id="send-btn" class="bg-blue-500 text-white p-3 rounded-r-lg hover:bg-blue-600 disabled:bg-blue-300">
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" /></svg>
            </button>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="api-key-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-60 items-center justify-center">
        <div class="bg-white rounded-lg p-8 shadow-2xl max-w-md w-full">
            <h2 class="text-xl font-bold mb-4">Enter Your Google AI Studio API Key</h2>
            <p class="text-gray-600 mb-4">To use the Gemini-powered features, please enter your API key. You can get one for free from <a href="https://aistudio.google.com/" target="_blank" class="text-blue-500 hover:underline">Google AI Studio</a>.</p>
            <input type="password" id="api-key-input" class="w-full border rounded-lg p-3 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Paste your API key here">
            <div class="flex justify-end space-x-4">
                <button id="cancel-api-key-btn" class="text-gray-600">Cancel</button>
                <button id="save-api-key-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Save Key</button>
            </div>
        </div>
    </div>
    
    <!-- Summary Modal -->
    <div id="summary-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-60 items-center justify-center p-4">
        <div class="bg-white rounded-lg p-8 shadow-2xl max-w-2xl w-full">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">✨ Conversation Summary</h2>
                <button id="close-summary-btn" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="summary-content" class="text-gray-700 max-h-96 overflow-y-auto"></div>
        </div>
    </div>


    <script>
        // DOM Elements
        const patientBtn = document.getElementById('patient-btn'), doctorBtn = document.getElementById('doctor-btn');
        const chatWindow = document.getElementById('chat-window'), messageInput = document.getElementById('message-input'), sendBtn = document.getElementById('send-btn');
        const summarizeBtn = document.getElementById('summarize-btn');
        const apiKeyModal = document.getElementById('api-key-modal'), apiKeyInput = document.getElementById('api-key-input');
        const saveApiKeyBtn = document.getElementById('save-api-key-btn'), cancelApiKeyBtn = document.getElementById('cancel-api-key-btn');
        const summaryModal = document.getElementById('summary-modal'), summaryContent = document.getElementById('summary-content'), closeSummaryBtn = document.getElementById('close-summary-btn');

        // State Management
        let audience = 'patient', isWaitingForResponse = false;
        let geminiApiKey = null;
        let chatHistory = [];
        let resolveApiKeyPromise = null;
        const API_KEY_STORAGE_KEY = 'healix-gemini-api-key';

        // --- Event Listeners ---
        window.addEventListener('DOMContentLoaded', loadApiKey);
        patientBtn.addEventListener('click', () => setAudience('patient'));
        doctorBtn.addEventListener('click', () => setAudience('doctor'));
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', (e) => e.key === 'Enter' && sendMessage());
        summarizeBtn.addEventListener('click', handleSummarizeClick);
        saveApiKeyBtn.addEventListener('click', saveApiKey);
        cancelApiKeyBtn.addEventListener('click', () => apiKeyModal.classList.remove('active'));
        closeSummaryBtn.addEventListener('click', () => summaryModal.classList.remove('active'));
        
        function setAudience(newAudience) {
            if (audience !== newAudience) {
                audience = newAudience;
                patientBtn.classList.toggle('bg-white'); patientBtn.classList.toggle('text-blue-600'); patientBtn.classList.toggle('shadow');
                doctorBtn.classList.toggle('bg-white'); doctorBtn.classList.toggle('text-blue-600'); doctorBtn.classList.toggle('shadow');
            }
        }
        
        // --- Core Functions ---
        function addMessage(sender, text, isFollowUp = false) {
            const sanitizedText = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            chatHistory.push({ role: sender, text: sanitizedText });
            let messageElement;
            if (sender === 'user') {
                messageElement = `<div class="flex justify-end mb-4"><div class="bg-blue-500 text-white rounded-lg p-3 max-w-xs md:max-w-md">${sanitizedText}</div></div>`;
            } else {
                messageElement = `
                    <div class="flex justify-start mb-4">
                        <div class="bg-slate-200 text-gray-800 rounded-lg p-3 max-w-xs md:max-w-md">
                            ${sanitizedText}
                            ${isFollowUp ? '' : `<div class="mt-3 pt-3 border-t border-slate-300"><button onclick="handleFollowUpClick(this)" class="text-xs font-semibold text-blue-600 hover:underline">✨ Suggest follow-up questions</button></div>`}
                        </div>
                    </div>`;
            }
            chatWindow.insertAdjacentHTML('beforeend', messageElement);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function showLoadingIndicator(isGemini = false) {
            const loadingId = `loading-${Date.now()}`;
            const loadingElement = `
                <div id="${loadingId}" class="flex justify-start mb-4">
                    <div class="bg-slate-200 text-gray-800 rounded-lg p-3 max-w-xs md:max-w-md">
                        <div class="flex space-x-1 items-center">
                           <div class="pulsing-dot"></div><div class="pulsing-dot"></div><div class="pulsing-dot"></div>
                           ${isGemini ? '<span class="text-xs ml-2 font-medium text-gray-600">Using Gemini...</span>' : ''}
                        </div>
                    </div>
                </div>`;
            chatWindow.insertAdjacentHTML('beforeend', loadingElement);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return loadingId;
        }

        async function sendMessage() {
            const messageText = messageInput.value.trim();
            if (!messageText || isWaitingForResponse) return;
            addMessage('user', messageText);
            messageInput.value = '';
            setChatState(true);
            const loadingId = showLoadingIndicator();
            try {
                const response = await fetch('http://127.0.0.1:8000/chat', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: messageText, audience: audience }),
                });
                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                const result = await response.json();
                document.getElementById(loadingId)?.remove();
                addMessage('AI', result.response);
            } catch (error) {
                const loadingElement = document.getElementById(loadingId);
                if (loadingElement) loadingElement.querySelector('div div').innerHTML = `<span class="text-red-500">Error: Could not connect to the Healix AI server.</span>`;
                console.error('Chat Error:', error);
            } finally {
                setChatState(false);
            }
        }
        
        // --- ✨ GEMINI API & KEY MANAGEMENT FUNCTIONS ---
        
        function loadApiKey() {
            const savedKey = localStorage.getItem(API_KEY_STORAGE_KEY);
            if (savedKey) {
                geminiApiKey = savedKey;
            }
        }

        function getApiKey() {
            return new Promise((resolve) => {
                if (geminiApiKey) {
                    resolve(geminiApiKey);
                } else {
                    apiKeyModal.classList.add('active');
                    resolveApiKeyPromise = resolve;
                }
            });
        }

        function saveApiKey() {
            const key = apiKeyInput.value.trim();
            if (key) {
                geminiApiKey = key;
                localStorage.setItem(API_KEY_STORAGE_KEY, key);
                apiKeyModal.classList.remove('active');
                if (resolveApiKeyPromise) {
                    resolveApiKeyPromise(geminiApiKey);
                    resolveApiKeyPromise = null;
                }
            }
        }
        
       async function callGemini(prompt, isJson = false) {
            const key = await getApiKey();
            if (!key) return { error: "API Key not provided.", isError: true };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${key}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            if (isJson) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: { type: "ARRAY", items: { type: "STRING" } }
                };
            }
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || `Request failed with status ${response.status}`);
                }
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini API Error:", error);
                return { error: error.message, isError: true };
            }
        }

        async function handleFollowUpClick(button) {
            button.innerText = '✨ Thinking...';
            button.disabled = true;
            const conversationContext = chatHistory.slice(-4).map(m => `${m.role}: ${m.text}`).join('\n');
            
            // --- NEW ROBUST METHOD ---

            // Step 1: Ask for a simple text list
            const prompt1 = `Based on this recent conversation, suggest three short, relevant follow-up questions a user might have. Return them as a simple numbered list.\n\nCONVERSATION:\n${conversationContext}`;
            const textResult = await callGemini(prompt1);
            
            const followUpContainer = button.parentElement;
            followUpContainer.innerHTML = ''; 

            if (textResult.isError) {
                followUpContainer.innerHTML = `<span class="text-xs text-red-500">Gemini Error: ${textResult.error}</span>`;
                return;
            }
            
            // Step 2: Ask the AI to parse its own messy output into clean JSON
            const prompt2 = `From the following text, extract only the questions into a clean JSON array of strings, like ["question 1", "question 2"].\n\nTEXT:\n${textResult}`;
            const jsonResult = await callGemini(prompt2, true);

            if (jsonResult.isError) {
                followUpContainer.innerHTML = `<span class="text-xs text-red-500">Gemini Error (Parsing Step): ${jsonResult.error}</span>`;
            } else {
                 try {
                    const questions = JSON.parse(jsonResult);
                    const questionButtonsHtml = questions.map(q => 
                        `<button onclick="askFollowUp('${q.replace(/'/g, "\\'")}')" class="follow-up-btn w-full text-left text-sm p-2 bg-white rounded-md mb-2 shadow-sm border border-slate-200 hover:bg-blue-50">${q}</button>`
                    ).join('');
                    followUpContainer.innerHTML = `<p class="text-xs font-semibold mb-2 text-gray-700">Suggested Questions:</p>${questionButtonsHtml}`;
                } catch (e) {
                    console.error("Failed to parse final Gemini JSON:", e, "Original response:", jsonResult);
                     const sanitizedResult = String(jsonResult).replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    followUpContainer.innerHTML = `<div class="text-xs text-red-500">
                        <p class="font-bold">Could not parse final Gemini response.</p>
                        <p class="mt-2">Raw output:</p>
                        <pre class="bg-red-100 p-2 rounded mt-1 whitespace-pre-wrap font-mono">${sanitizedResult}</pre>
                    </div>`;
                }
            }
        }

        function askFollowUp(question) {
            messageInput.value = question;
            sendMessage();
        }
        
        async function handleSummarizeClick() {
            if (chatHistory.length < 2) {
                alert("Not enough conversation to summarize!");
                return;
            }
            summaryContent.innerHTML = '<div class="flex justify-center items-center"><div class="pulsing-dot"></div><div class="pulsing-dot"></div><div class="pulsing-dot"></div></div>';
            summaryModal.classList.add('active');
            
            const fullConversation = chatHistory.map(m => `${m.role}: ${m.text}`).join('\n');
            const prompt = `Concisely summarize the key points of the following medical Q&A conversation into a few bullet points.\n\nCONVERSATION:\n${fullConversation}`;
            
            const result = await callGemini(prompt.slice(-8000));
            if (result.isError) {
                summaryContent.innerHTML = `<span class="text-red-500">Gemini Error: ${result.error}</span>`;
            } else {
                summaryContent.innerHTML = result.replace(/\n/g, '<br>');
            }
        }

        function setChatState(isWaiting) {
            isWaitingForResponse = isWaiting;
            sendBtn.disabled = isWaiting;
            messageInput.disabled = isWaiting;
        }
    </script>
</body>
</html>

